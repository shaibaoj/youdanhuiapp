<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/app.css"/>
		<link rel="stylesheet" type="text/css" href="css/mall.css"/>
	<link rel="stylesheet" type="text/css" href="css/u.css"/>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav ">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">商城购物</h1>
		</header>
		<div class="mui-content">
		    <div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll">
						<a class="mui-control-item mui-active" href="#item0mobile">热门商家</a>
						<a class="mui-control-item" href="#item1mobile" data-title="保险">保险</a>
						<a class="mui-control-item" href="#item2mobile" data-title="医药健康">医药健康</a>
						<a class="mui-control-item" href="#item3mobile" data-title="名品特卖">名品特卖</a>
						<a class="mui-control-item" href="#item4mobile" data-title="团购">团购</a>
						<a class="mui-control-item" href="#item5mobile" data-title="图书音像">图书音像</a>
						<a class="mui-control-item" href="#item6mobile" data-title="奢侈品">奢侈品</a>
						<a class="mui-control-item" href="#item7mobile" data-title="女性/内衣">女性/内衣</a>
						<a class="mui-control-item" href="#item8mobile" data-title="娱乐交友">娱乐交友</a>
						<a class="mui-control-item" href="#item9mobile" data-title="家居家饰">家居家饰</a>
						<a class="mui-control-item" href="#item10mobile" data-title="成人保健">成人保健</a>
						<a class="mui-control-item" href="#item11mobile" data-title="手机/数码/家电">手机/数码/家电</a>
						<a class="mui-control-item" href="#item12mobile" data-title="教育培训">教育培训</a>
						<a class="mui-control-item" href="#item13mobile" data-title="服装服饰">服装服饰</a>
						<a class="mui-control-item" href="#item14mobile" data-title="母婴/儿童用品">母婴/儿童用品</a>
						<a class="mui-control-item" href="#item15mobile" data-title="汽车用品">汽车用品</a>
						<a class="mui-control-item" href="#item16mobile" data-title="珠宝首饰">珠宝首饰</a>
						<a class="mui-control-item" href="#item17mobile" data-title="电视购物">电视购物</a>
						<a class="mui-control-item" href="#item18mobile" data-title="票务旅游">票务旅游</a>
						<a class="mui-control-item" href="#item19mobile" data-title="箱包/眼镜/鞋类">箱包/眼镜/鞋类</a>
						<a class="mui-control-item" href="#item20mobile" data-title="综合商城">综合商城</a>
						<a class="mui-control-item" href="#item21mobile" data-title="网络服务/其他">网络服务/其他</a>
						<a class="mui-control-item" href="#item22mobile" data-title="美容化妆">美容化妆</a>
						<a class="mui-control-item" href="#item23mobile" data-title="运动户外">运动户外</a>
						<a class="mui-control-item" href="#item24mobile" data-title="金融理财">金融理财</a>
						<a class="mui-control-item" href="#item25mobile" data-title="食品/茶叶/酒水">食品/茶叶/酒水</a>
						<a class="mui-control-item" href="#item26mobile" data-title="鲜花礼品">鲜花礼品</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div id="item0mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="0">
								<ul class="mui-table-view mui-table-view-chevron">
								</ul>
							</div>
						</div>
					</div>
					<div id="item1mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="1">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="2">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item3mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="3">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item4mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="4">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item5mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="5">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item6mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="6">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item7mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="7">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item8mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="8">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item9mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="9">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item10mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="10">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item11mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="11">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item12mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="12">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item13mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="13">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item14mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="14">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item15mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="15">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item16mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="16">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item17mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="17">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item18mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="18">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item19mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="19">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item20mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="20">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item21mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="21">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item22mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="22">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item23mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="23">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item24mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="24">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item25mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="25">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
					<div id="item26mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" data-cid="26">
								<ul class="mui-table-view mui-table-view-chevron"></ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="libs/arttmpl.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.pullToRefresh.js"></script>
		<script src="js/mui.pullToRefresh.material.js"></script>
		<script src="js/mui.lazyload.js"></script>
		<script src="js/mui.lazyload.img.js"></script>
		<script src="js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/config.js" ></script>
		<script src="js/app.js" ></script><script src="js/cn.js" ></script>
		<script id="tpl-coupon-goods" type="text/html">	            
	        {{each list as value i}}
	        <li class="border_b malls-list">
				<a href="{{value.click_url}}" data-url="{{value.click_url}}" data-title="{{value.sitename}}">
                    <div class="malls-item">
                        <img class="mall-logo" src="{{value.pic_url}}">
                        <span class="mall-name">{{value.sitename}}</span>
                        {{if value.commission_rate }}
                        <span class="mall-rate">最高{{value.commission_rate}}</span>
                        {{/if}}
                    </div>
                </a>
			</li>
		    {{/each}}
		</script>
		<script type="text/javascript">
    		app_cn.set_txt('mall');
		var webview_web = null; //详情页webview
		var query_cid_items = {"item0":1};
			
		mui.init({
			swipeBack:true //启用右滑关闭功能
		});
		
		document.querySelector('.mui-slider').addEventListener('slide', function(event) {
			var slideNumber  = event.detail.slideNumber;
			if(!query_cid_items.hasOwnProperty("item"+slideNumber)){
				query_cid_items["item"+slideNumber] = "1";
				if(slideNumber!=0){
					plus.nativeUI.showWaiting("加载中");
				}
				var scroll_data =  document.querySelector("#item"+slideNumber+"mobile .mui-scroll");
				var min_date = scroll_data.getAttribute("data-min-date");
				var max_date = scroll_data.getAttribute("data-max-date");
				query_coupon_goods({
					cid:slideNumber,
					min_date:min_date,
					max_date:max_date,
				});
			}
		});
		
		function query_coupon_goods(conditon_detail){
			var cid = conditon_detail.cid?conditon_detail.cid:'';
			mui.web_query('mall', {cid:cid}, function(data){
				plus.nativeUI.closeWaiting();
				if(data && data.data.items.length > 0) {
					var datas = {
					    list: data.data.items
					};
					var html = template('tpl-coupon-goods', datas);
					document.querySelector("#item"+cid+"mobile .mui-table-view").innerHTML=html;
				}
			}, function(tatus,status_err){
				plus.nativeUI.closeWaiting();
				 switch(status){
				    case 2:
				        plus.nativeUI.toast(status_err, {verticalAlign: 'center'});
				        break;
				    default:
				    		plus.nativeUI.toast(status_err, {verticalAlign: 'center'});
				        break;
			    }
			}, 3);
		}
		
		mui.plusReady(function () {
			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios?0.003:0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: false, //是否显示滚动条
					deceleration:deceleration
				});
				$.ready(function() {
					//循环初始化所有下拉刷新，上拉加载。
					$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
							down: {
								contentdown: "下拉可以刷新", //可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
								callback: function() {
									var self = this;
									var cid = self.element.getAttribute("data-cid");
									$.web_query('mall', {
										cid:cid?cid:'',
									}, function(data){
										self.endPullDownToRefresh(false);
										if(data && data.data.items.length > 0) {
											var datas = {
											    title: '标签',
											    list: data.data.items
											};
											var html = template('tpl-coupon-goods', datas);
											self.element.querySelector('.mui-table-view').insertAdjacentHTML("afterBegin",html);
										}
									}, function(tatus,status_err){
										 switch(status){
										    case 2:
										        plus.nativeUI.toast(status_err, {verticalAlign: 'center'});
										        break;
										    default:
										    		plus.nativeUI.toast(status_err, {verticalAlign: 'center'});
										        break;
									    }
									}, 3);
									
								}
							},
							up: {
	//							auto: true,
								contentinit: '稍等，精彩即将开始',
	//		                    contentdown: '优质宝贝一波波来袭',
			                    contentrefresh: '正在加载...',
			                    contentnomore: '没有更多数据了',
								callback: function() {
									var self = this;
									var cid = self.element.getAttribute("data-cid");
									$.web_query('mall', {
										cid:cid?cid:'',
									}, function(data){
										self.endPullUpToRefresh(false);
										if(data && data.data.items.length > 0) {
											var datas = {
											    list: data.data.items
											};
											var html = template('tpl-coupon-goods', datas);
											self.element.querySelector('.mui-table-view').insertAdjacentHTML("beforeEnd",html);
										}else{
											self.endPullUpToRefresh(true);
										}
									}, function(tatus,status_err){
										 switch(status){
										    case 2:
										        plus.nativeUI.toast(status_err, {verticalAlign: 'center'});
										        break;
										    default:
										    		plus.nativeUI.toast(status_err, {verticalAlign: 'center'});
										        break;
									    }
									}, 3);
								}
							}
						});
					});
				});
				query_coupon_goods({
					cid:'0'
				});
			})(mui);
		    //预加载详情页
			webview_web = mui.preload({
			    url:'web.html',
			    id:'web.html',
			    styles:{},//窗口参数
			    extras:{}//自定义扩展参数
			});
		})

		//TODO 后续应该封装一个v-tap指令，实现tap监听
		mui('.mui-content').on('tap', '[data-url]', function() {
			var url = this.getAttribute('data-url');
			var title = this.getAttribute("data-title").trim();
			open_web({
				title:title,
				url:url
			});
		});

		function open_web(json_detail) {
			if(!webview_web) {
				setTimeout(function() {
					open_web(json_detail);
				}, 100);
			}
			
			mui.fire(webview_web, 'open_url', {
				title: json_detail.title,
				url: json_detail.url
			});

			setTimeout(function () {
				webview_web.show("slide-in-right", 300);
			},150);
		}

		document.addEventListener('scroll_top',function (event) {
			mui('#slider').slider().gotoItem(0);
			mui('#scroll1').scroll().scrollTo(0,0,1000);
			window.scrollTo(0, 1000);
		})
		</script>
	</body>
</html>